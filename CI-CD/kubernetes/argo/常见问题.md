# 常见问题

## workflow 默认使用 root 账号？

workflow 的流程默认使用 root 账号，如果你的镜像默认使用非 root 账号，而且要修改文件，就很可能遇到 Permission Denined 的问题。

解决方法：通过 Pod Security Context 手动设定容器的 user/group:

- [Workflow Pod Security Context](https://argoproj.github.io/argo/workflow-pod-security-context/)


安全起见，我建议所有的 workflow 都手动设定 `securityContext`，示例：

```yaml
apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: xxx
spec:
  securityContext:
    runAsNonRoot: true
    runAsUser: 1000
```

或者也可以通过 `workflow-controller-configmap` 的 `workflowDefaults` 设定默认的 workflow 配置。

## 如何从 hashicorp vault 中读取 secrets?

>参考 [Support to get secrets from Vault](https://github.com/argoproj/argo/issues/3267#issuecomment-650119636)

hashicorp vault 目前可以说是云原生领域最受欢迎的 secrets 管理工具。
我们在生产环境用它做为分布式配置中心，同时在本地 CI/CD 中，也使用它存储相关的敏感信息。

现在迁移到 argo，我们当然希望能够有一个好的方法从 vault 中读取配置。

目前最推荐的方法，是使用 vault 的 vault-agent，将 secrets 以文件的形式注入到 pod 中。

通过 valut-policy - vault-role - k8s-serviceaccount 一系列认证授权配置，可以制定非常细粒度的 secrets 权限规则，而且配置信息阅后即焚，安全性很高。


## 如何在多个名字空间中使用同一个 secrets?

使用 Namespace 对 workflow 进行分类时，遇到的一个常见问题就是，如何在多个名字空间使用 `private-git-creds`/`docker-config`/`minio`/`vault` 等 workflow 必要的 secrets.

常见的方法是把 secrets 在所有名字空间 create 一次。

但是也有更方便的 secrets 同步工具：

比如，使用 [kyverno](https://github.com/kyverno/kyverno) 进行 secrets 同步的配置：

```yaml
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: sync-secrets
spec:
  background: false
  rules:
  # 将 secret vault 从 argo Namespace 同步到其他所有 Namespace
  - name: sync-vault-secret
    match:
      resources:
        kinds:
        - Namespace
    generate:
      kind: Secret
      name: regcred
      namespace: "{{request.object.metadata.name}}"
      synchronize: true
      clone:
        namespace: argo
        name: vault
  # 可以配置多个 rules，每个 rules 同步一个 secret
```

上面提供的 kyverno 配置，会实时地监控所有 Namespace 变更，一但有新 Namespace 被创建，它就会立即将 `vault` secret 同步到该 Namespace.

或者，使用专门的 secrets/configmap 复制工具：[kubernetes-replicator](https://github.com/mittwald/kubernetes-replicator)

## Argo 对 CR 资源的验证不够严谨，写错了 key 都不报错

待研究

